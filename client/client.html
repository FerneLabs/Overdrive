<!DOCTYPE html>
<html>
    <head>
        <title>Document</title>
    </head>
    <body>
        <input id="player-id" type="text" placeholder="Your ID">
        <button onclick="joinMatch()">Look for match</button>

        <h1>Game State</h1>
        
        <p>Your state</p>
        <ul id="state"></ul>

        <p>Enemy state</p>
        <ul id="state-enemy"></ul>

        <h1>Slot Machine</h1>
        <button onclick="requestSpin()">Spin</button>
        <button onclick="sendSpin()">Confirm spin</button>
        <div id="slot-machine-container">
            <ul id="slot-machine"></ul>
        </div>
        <details>
            <summary>Messages</summary>
            <ul id="messages"></ul>
        </details>
        
        <script>
            let stateElement = document.querySelector('#state');
            let enemyStateElement = document.querySelector('#state-enemy');
            let messagesElement = document.querySelector('#messages');
            let slotMachineContainer = document.querySelector('#slot-machine-container');
            let slotMachineElement = document.querySelector('#slot-machine');
            const idInput = document.getElementById("player-id");

            let matchId = '';
            let spinResult = [];

            const socket = new WebSocket("ws://localhost:8080");

            // Event listener for WebSocket connection open
            socket.addEventListener("open", () => {
                console.log("Connected to WebSocket server.");
            });
            
            socket.addEventListener("close", () => {
                console.log("Disconnected from WebSocket server.");
            });

            // Event listener for incoming messages 
            socket.addEventListener("message", (event) => {
                
                let data = JSON.parse(event.data.toString());
                if (data.matchId) {
                    matchId = data.matchId;
                }
                const playerId = idInput.value;
                
                // Log messages
                // Overwrite with new message on top and the rest behind
                messagesElement.innerHTML = `<li>${JSON.stringify(data)}</li><li> -------- </li>${messagesElement.innerHTML}`;
                
                // Update state
                if (data.state) {
                    let playerKeys = Object.keys(data.state.players);
                    playerKeys.forEach(playerIdKey => {
                        if (playerIdKey == playerId) {
                            stateElement.innerHTML = `
                                <li>${JSON.stringify(data.state?.players[playerIdKey])}</li> 
                            `;
                        } else {
                            enemyStateElement.innerHTML = `
                                <li>${JSON.stringify(data.state?.players[playerIdKey])}</li> 
                            `;
                        }
                    });
                }
                
                // Update spin data
                if (data.spinResult) {
                    spinResult = data.spinResult;
                    slotMachineElement.innerHTML = '';
                    spinResult.forEach((slot, index) => {
                        slotMachineElement.innerHTML += `<li>Slot ${index + 1}: ${slot.type} || ${slot.value}</li>`;
                    });
                }

                // Handle game over
                if (data.state.isGameOver && data.state.winner) { // Let some time to update UI to latest state
                    setTimeout(() => {
                        window.alert(data.state.winner === playerId ? `You win!!` : `You lost :( XD)`);
                        window.location.reload();
                    }, 1000);
                }
                
                console.log(data);
            });

            function joinMatch() {
                const playerId = idInput.value;
                const message = {
                    type: 'searchGame',
                    matchId: null,
                    playerId: playerId,
                    action: []
                };
                socket.send(JSON.stringify(message));
            }

            function requestSpin() {
                const playerId = idInput.value;
                
                if (!matchId) {
                    console.error('No match ID present');
                    return;
                }

                const message = {
                    type: 'requestSpin',
                    matchId: matchId,
                    playerId: playerId,
                    actions: []
                };
                socket.send(JSON.stringify(message));
            }

            function sendSpin() {
                const playerId = idInput.value;
                
                if (!matchId) {
                    console.error('No match ID present');
                    return;
                }

                const message = {
                    type: 'sendAction',
                    matchId: matchId,
                    playerId: playerId,
                    actions: spinResult
                };
                socket.send(JSON.stringify(message));

                spinResult = [];
                slotMachineElement.innerHTML = '';
            }
        </script>
    </body>
</html>
